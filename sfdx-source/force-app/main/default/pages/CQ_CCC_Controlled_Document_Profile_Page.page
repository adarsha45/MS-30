<!-------------------------------------------REVISION HISTORY---------------------------------------------

[CCC-116] Document Management: Approval History is not correctly shown in the cover page of the document

--------------------------------------------REVISION HISTORY---------------------------------------------->

<apex:page renderAs="{!IF($CurrentPage.Parameters.RenderAs == 'pdf', 'pdf', null)}" standardController="compliancequest__SQX_Controlled_Document__c" extensions="compliancequest.SQX_Extension_Controlled_Document,CQ_CCC_Extension_Controlled_Document" title="{!compliancequest__SQX_Controlled_Document__c.Name}" doctype="html-5.0" applyBodyTag="false" showHeader="false" sidebar="false" standardStylesheets="true">
    
    <apex:variable var="renderAsPdf" value="{!$CurrentPage.Parameters.RenderAs == 'pdf'}" />
    <apex:variable var="isLandscape" value="{!$CurrentPage.Parameters.Mode == 'LS'}" />
    <apex:variable var="proc" value="{! COOrCDLatestApprovalProcess }" />
    <apex:variable var="activeReq" value="{!DocActiveRequirements}" />
    
    <head>
        <style>            
            @page {
            size : {!IF(isLandscape, 'landscape', 'portrait')};
            @top-center {
            content: element(header);
            }
            @bottom-left {
            content: element(footer);
            }
            margin: {!IF(isLandscape, '1.7in .94in 1in .94in', '.50in .42in 1in .45in')};
            }
            tr{page-break-inside:avoid;}
            body {            
            background-color: white;
            font-size: {!IF(renderAsPdf, '0.6em', '0.9em')};
            font-family: Arial, Helvetica, sans-serif;
            padding: {!IF(renderAsPdf, '0', '0em')};            
            }            
            .tbl { padding : 3px; width: 100% }
            .tbl tr {padding-top:2px;}
            .label { font-weight: bold; text-align: right; }
            .fieldValue {padding-left:3px;}            
            .subSection {
            background-color: transparent;
            }            
            .subSection h3 { font-size: 1.2em; padding: 5px 12px; }            
            .pShowMore { display:none; }            
            .noRecordToDisplay { padding: 5px 0px; border-width: 1px 0; border-top-color: #4a4a56; border-bottom-color:#d4dadc; border-style:solid; }            
            .top { text-align: center;  margin-bottom: 10px; width:100%}            
            .logo{margin:0px 0px 10px 0px !important; border: 1px solid black; width:100%}
            .effectivedate{font-style: italic;}
            .right{ float: right;}
            .left{text-align:left}
            .center{text-align:center}
            div.footer {
            border-style:none;
            border-width: 1px 0 0 0;
            font-size: 0.72em;
            display: block;
            padding: 5px;
            position: running(footer);
            }
            .compName{
            font-weight: bold;
            text-decoration: underline;}
            .hidden{display:none}
            .left-gap{padding-left:10px}
            .bold{font-weight:bold;}
            .logo-image{text-align: left; margin: 1px 0px 0px 10px !important; width:70%}
        </style>
    </head>
    
    <body>
        <!-- Header Section -->
        <!-- hidden to mimic OOB profile page -->
       
        <div class="top">
            <apex:pageBlock >
                <apex:outputPanel >
                    <table id="header" border="1px" cellpadding="3px" cellspacing="0">
                        <tr>
                            <td class="logo-image" style='width:30%'><apex:image url="{!$Resource.CQ_Logo}" height="15px"/></td>
                            <td style='width:70%'>
                                <span class="bold">{!$ObjectType.compliancequest__SQX_Controlled_Document__c.Fields.compliancequest__Document_Number__c.Label} :</span>                              
                                {!compliancequest__SQX_Controlled_Document__c.compliancequest__Document_Number__c}                                
                                <br/>
                                <p>
                                    Revision:
                                    {!compliancequest__SQX_Controlled_Document__c.compliancequest__Revision__c}
                                </p> 
                            </td>
                        </tr>
                        <tr>
                            <td colspan = "2">  
                                <span class="bold">{!$ObjectType.compliancequest__SQX_Controlled_Document__c.Fields.compliancequest__Title__c.Label} :</span>
                                {!compliancequest__SQX_Controlled_Document__c.compliancequest__Title__c}
                            </td>                            
                        </tr>
                        
                         <!--
                        <tr>
                            <td >
                                {!$ObjectType.compliancequest__SQX_Controlled_Document__c.Fields.compliancequest__Document_Type__c.Label} :
                                :
                                {!compliancequest__SQX_Controlled_Document__c.compliancequest__Document_Type__c}                                
                            </td>
                            <td> 
                                <apex:outputText value="{!$ObjectType.compliancequest__SQX_Controlled_Document__c.Fields.compliancequest__Effective_Date__c.Label} : " />
                                <apex:outputText styleClass="bold" value="{0,date,d/M/yyyy}">
                                    <apex:param value="{!compliancequest__SQX_Controlled_Document__c.compliancequest__Effective_Date__c}"/>
                                </apex:outputText> 
                            </td>
                        </tr>
                        -->
                    </table>
                </apex:outputPanel>
            </apex:pageBlock>
        </div>
        
        
        <!-- Detail layout Section -->        
        <div class="subSection" >
            <apex:pageBlock >
                <apex:pageBlockSection columns="1" collapsible="false">
                    <apex:pageBlockSectionItem >
                        <apex:outputLabel value="{!$Label.compliancequest__CQ_UI_Controlled_Doc_Author}:" />
                        <apex:outputText styleClass="left-gap" value="{!compliancequest__SQX_Controlled_Document__c.Owner.Name}"/>
                    </apex:pageBlockSectionItem>
                    <apex:pageBlockSectionItem >
                        <apex:outputLabel value="{!$ObjectType.compliancequest__SQX_Controlled_Document__c.Fields.compliancequest__Document_Category__c.Label}: "/>
                        <apex:outputPanel styleClass="left-gap">
                            <apex:outputField value="{!compliancequest__SQX_Controlled_Document__c.compliancequest__Document_Category__c}"/>
                        </apex:outputPanel>
                    </apex:pageBlockSectionItem>
                    <apex:pageBlockSectionItem >
                        <apex:outputLabel value="{!$ObjectType.compliancequest__SQX_Controlled_Document__c.Fields.compliancequest__Document_Status__c.Label}:"/>
                        <apex:outputPanel styleClass="left-gap">
                            <apex:outputField value="{!compliancequest__SQX_Controlled_Document__c.compliancequest__Document_Status__c}"/>
                        </apex:outputPanel>
                    </apex:pageBlockSectionItem>
                    <apex:pageBlockSectionItem >
                        <apex:outputLabel value="{!$ObjectType.compliancequest__SQX_Controlled_Document__c.Fields.compliancequest__Date_Approved__c.Label}: "/>
                        <apex:outputPanel styleClass="left-gap">
                            <apex:outputText value="{!CCCCoverPageDateFormat}" rendered="{!NOT(ISNULL(CCCCoverPageDateFormat))}">
                                <apex:param value="{!compliancequest__SQX_Controlled_Document__c.compliancequest__Date_Approved__c}"/>
                            </apex:outputText>
                            <apex:outputField value="{! compliancequest__SQX_Controlled_Document__c.compliancequest__Date_Approved__c }" rendered="{!ISNULL(CCCCoverPageDateFormat)}"/>
                        </apex:outputPanel>
                    </apex:pageBlockSectionItem>
                    <apex:pageBlockSectionItem >
                        <apex:outputLabel value="{!$ObjectType.compliancequest__SQX_Controlled_Document__c.Fields.compliancequest__Expiration_Date__c.Label}: " />
                        <apex:outputPanel styleClass="left-gap">
                            <apex:outputText value="{!CCCCoverPageDateFormat}" rendered="{!NOT(ISNULL(CCCCoverPageDateFormat))}">
                                <apex:param value="{!compliancequest__SQX_Controlled_Document__c.compliancequest__Expiration_Date__c}"/>
                            </apex:outputText>
                            <apex:outputField value="{! compliancequest__SQX_Controlled_Document__c.compliancequest__Expiration_Date__c }" rendered="{!ISNULL(CCCCoverPageDateFormat)}"/>
                        </apex:outputPanel>
                    </apex:pageBlockSectionItem>
                </apex:pageBlockSection>
            </apex:pageBlock>
        </div>
        
        <!-- Document Approval History -->
        <div class="subSection">
            <apex:pageBlock title="{!$Label.compliancequest__CQ_UI_Controlled_Document_Approval_History}" >     
                <apex:pageBlockSection rendered="{!ISNULL(proc.Instance.StepsAndWorkItems)}" columns="1">
                    <p class="noRecordToDisplay" >{!$Label.compliancequest__CQ_UI_No_records_to_display}</p>
                </apex:pageBlockSection>
                <apex:outputPanel rendered="{!NOT(ISNULL(proc.Instance.StepsAndWorkItems))}">                    
                    <table id="approvalHistoryTable" class="list" border="1px" cellpadding="3px" cellspacing="0">
                        <tr class="headerRow">
                            <th scope="col">{!$Label.CQ_CCC_UI_Step}</th>
                            <th scope="col">{!$Label.CQ_CCC_UI_Approver}</th>
                            <th scope="col">{!$Label.CQ_CCC_UI_Date_Approved}</th>
                        </tr>
                        <apex:repeat var="proc" value="{!proc}" rows="1" >
                            <apex:repeat var="step" value="{! proc.Instance.StepsAndWorkItems }" rendered="{!NOT(ISNULL(proc))}">
                                <apex:outputText rendered="{!step.StepStatus == 'Approved'}" >
                                    <tr>
                                        <td width="40%">
                                            <apex:outputField value="{!step.ProcessNode.Name}" />
                                        </td>
                                        <td width="20%">
                                            <apex:outputField value="{!step.Actor.Name}" />
                                        </td>
                                        <td width="20%" >
                                            <apex:outputText value="{!CCCCoverPageDateTimeFormat}" rendered="{!NOT(ISNULL(CCCCoverPageDateTimeFormat))}">
                                                <apex:param value="{!step.CreatedDate}"/>
                                            </apex:outputText>
                                            <apex:outputField value="{! step.CreatedDate }" rendered="{!ISNULL(CCCCoverPageDateTimeFormat)}"/>
                                        </td>
                                    </tr>
                                </apex:outputText>
                            </apex:repeat>
                        </apex:repeat>
                    </table>
                </apex:outputPanel>                
            </apex:pageBlock>
        </div>
        
        <div class="subSection">
            
            <apex:pageBlock Title="{!$Label.compliancequest__CQ_UI_Controlled_Document_Revision_History}" rendered="{! latestRevisions.size > 0}"> 
                <apex:pageBlockTable value="{!latestRevisions}" var="doc" border="1px" cellpadding="3px" align="center" width="100%">
                    
                    <apex:column value="{! doc.compliancequest__Revision__c }" width="30%">
                        <apex:facet name="header">{!$Label.compliancequest__CQ_UI_Controlled_Doc_Revision}</apex:facet>
                    </apex:column>
                    
                    <apex:column value="{!$Label.compliancequest__CQ_UI_NA_Msg}" width="35%" rendered="{! doc.compliancequest__Changes__c == null}">
                        <apex:facet name="header">{!$ObjectType.compliancequest__SQX_Controlled_Document__c.Fields.compliancequest__Changes__c.Label}</apex:facet>
                    </apex:column>
                    
                    <apex:column value="{!doc.compliancequest__Changes__c}" width="35%" rendered="{! doc.compliancequest__Changes__c != null}">
                        <apex:facet name="header">{!$ObjectType.compliancequest__SQX_Controlled_Document__c.Fields.compliancequest__Changes__c.Label}</apex:facet>
                    </apex:column>
                    
                    <apex:column width="35%">
                        <apex:outputText value="{!CCCCoverPageDateFormat}" rendered="{!NOT(ISNULL(CCCCoverPageDateFormat))}"> 
                            <apex:param value="{! doc.compliancequest__Effective_Date__c }"/> 
                        </apex:outputText> 
                        <apex:outputField value="{! doc.compliancequest__Effective_Date__c }" rendered="{!ISNULL(CCCCoverPageDateFormat)}"/>
                        <apex:facet name="header">{!$ObjectType.compliancequest__SQX_Controlled_Document__c.Fields.compliancequest__Effective_Date__c.Label}</apex:facet>
                    </apex:column>
                    
                </apex:pageBlockTable>
            </apex:pageBlock>
        </div>
        
        
        <!-- Related Documents Section-->
        <div class="subSection hidden" id="relatedDocuments">
            
            <apex:pageBlock title="{!$Label.compliancequest__CQ_UI_Related_Documents}">
                
                <apex:pageBlockTable value="{!compliancequest__SQX_Controlled_Document__c.compliancequest__Related_Documents__r}" var="rDoc" cellpadding="3px" align="center" width="100%"  border="1px" >
                    
                    <apex:column headerValue="{!$ObjectType.compliancequest__SQX_Controlled_Document__c.Fields.compliancequest__Document_Number__c.Label}" width="30%">
                        <apex:outputlink value="{!$Setup.compliancequest__SQX_Custom_Settings_Public__c.compliancequest__Org_Base_URL__c}/apex/compliancequest__SQX_View_Controlled_Document?id={!rDoc.compliancequest__Referenced_Document__r.Id}">{!rDoc.compliancequest__Referenced_Document__r.Name}</apex:outputlink>
                    </apex:column>
                    <apex:column headerValue="{!$Label.compliancequest__CQ_UI_Title}" width="70%">
                        {!rDoc.compliancequest__Referenced_Document__r.compliancequest__Title__c}
                    </apex:column>
                    
                </apex:pageBlockTable>
                
            </apex:pageBlock>
            
        </div>
        
        <!-- Training Requirement Section
        <div class="subSection">
            
            <apex:pageBlock title="{!$Label.compliancequest__CQ_UI_Controlled_Doc_Training_Requirement}" rendered="{!NOT(ISNULL(activeReq))}">
                
                <apex:pageBlockTable value="{!activeReq}" var="reqJF" cellpadding="3px" align="center" width="100%"  border="1px" >
                    <apex:column headerValue="{!$ObjectType.compliancequest__SQX_Job_Function__c.Label}" width="30%">
                        <apex:outputlink value="{!$Setup.compliancequest__SQX_Custom_Settings_Public__c.compliancequest__Org_Base_URL__c}/{!reqJF.compliancequest__SQX_Job_Function__r.Id}">{!reqJF.compliancequest__SQX_Job_Function__r.Name}</apex:outputlink>
                    </apex:column>
                    <apex:column value="{!reqJF.compliancequest__SQX_Job_Function__r.compliancequest__Description__c}" width="70%"/>
                </apex:pageBlockTable>
                
            </apex:pageBlock>
            
        </div>
        -->
    </body>    
</apex:page>